name: Update lighthouse report artifact for main branch

on: 
  push:
    branches: 
      - main
  workflow_dispatch:

env:
  OWNER: nginxinc
  REPO: nginx-hugo-theme
jobs:
  generate-lighthouse-report:
    runs-on: ubuntu-22.04
    steps:
        - uses: actions/checkout@v5
          with:
            ref: ${{ github.event.workflow_run.head_branch }}
        - uses: actions/setup-node@v5
          with:
            node-version: 18
        - name: Installing packages
          run: cd performance && npm ci
        - name: Get PR number being merged
          run: |
            RESPONSE=$(curl -L \
              -X GET \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -s "https://api.github.com/repos/${{ env.OWNER }}/${{ env.REPO }}/pulls?state=closed&direction=desc&page=1&per_page=5")
            LATEST_PR_NUMBER=$(echo "$RESPONSE" | jq -r '.[] | select(.merged_at != null) | .number' | head -1)
            echo "GITHUB_PR_NUMBER=$LATEST_PR_NUMBER" >> $GITHUB_ENV
        - name: Generating lighthouse reports for main...
          env: 
            REPORT_NAME: "main"
            GITHUB_PR_NUMBER: ${{ env.GITHUB_PR_NUMBER }}
          run: |
            node performance/lighthouse-script.js
        - uses: actions/upload-artifact@v4
          with:
            name: lighthouse-reports
            path: lighthouse-reports/
            retention-days: 30
