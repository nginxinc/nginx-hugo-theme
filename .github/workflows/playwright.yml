name: Running Playwright test on UI

# Run the workflow when code is pushed or when a pull request is created
on:
    push:
      branches:
        - 'main'
    pull_request:

jobs:
    playwright:
        name: Run Playwright
        runs-on: ubuntu-latest
        steps: 
          # Checkout the repository so the workflow has access to the code
          - name: Checkout code
            uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3
          - name: Setup Hugo
            uses: peaceiris/actions-hugo@75d2e84710de30f6ff7268e08f310b60ef14033f # v3.0.0
            with:
                hugo-version: '0.147.8'
                extended: true
          - name: Install dependencies and playwright browsers
            run: cd tests && npm ci && npx playwright install --with-deps
          - name: Run Playwright tests
            id: test-ui
            run: |
              make tests | tee output.log
              if grep -q "failed" output.log; then
                echo "Playwright tests failed. Please view the Playwright report to see full error."
                exit 1
              fi
          - uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
            id: artifact-upload
            if: ${{ !cancelled() && failure() && steps.test-ui.conclusion == 'failure' }}
            with:
              name: playwright-report
              path: tests/playwright-report/
              retention-days: 3
          - name: Comment on PR with Playwright report
            uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
            if: ${{ failure() }}
            with:
              script: |
                const body = `### <span aria-hidden="true">‚ùå</span> Playwright differences were detected.
                
                View the [Playwright report](${{ steps.artifact-upload.outputs.artifact-url }})`;

                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: body,
                });
