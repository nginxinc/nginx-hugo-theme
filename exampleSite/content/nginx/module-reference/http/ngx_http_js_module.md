---
title: ngx_http_js_module
description: ngx_http_js_module
toc: true
nd-org-source: http/ngx_http_js_module.xml
nd-plus: false
nd-partial-plus: false
---


<!--
********************************************************************************
üõë WARNING: AUTOGENERATED FILE - DO NOT EDIT üõë
This Markdown file was automatically generated from the source XML documentation.
Any manual changes made directly to this file will be overwritten.
To request or suggest changes, please edit the source XML files instead.
https://github.com/nginx/nginx.org/tree/main/xml/en
********************************************************************************
-->


The `ngx_http_js_module` module is used to implement
location and variable handlers
in [njs](/nginx/module-reference/../njs/index)¬†‚Äî
a subset of the JavaScript language.

Download and install instructions are available
[here](/nginx/module-reference/../njs/install).
## Example Configuration


The example works since
[0.4.0](/nginx/module-reference/../njs/changes#njs0.4.0).

```nginx
http {
    js_import http.js;

    js_set $foo     http.foo;
    js_set $summary http.summary;
    js_set $hash    http.hash;

    resolver 10.0.0.1;

    server {
        listen 8000;

        location / {
            add_header X-Foo $foo;
            js_content http.baz;
        }

        location = /summary {
            return 200 $summary;
        }

        location = /hello {
            js_content http.hello;
        }

        # since 0.7.0
        location = /fetch {
            js_content                   http.fetch;
            js_fetch_trusted_certificate /path/to/ISRG_Root_X1.pem;
        }

        # since 0.7.0
        location = /crypto {
            add_header Hash $hash;
            return     200;
        }
    }
}

```


The http.js file:

```nginx
function foo(r) {
    r.log("hello from foo() handler");
    return "foo";
}

function summary(r) {
    var a, s, h;

    s = "JS summary\n\n";

    s += "Method: " + r.method + "\n";
    s += "HTTP version: " + r.httpVersion + "\n";
    s += "Host: " + r.headersIn.host + "\n";
    s += "Remote Address: " + r.remoteAddress + "\n";
    s += "URI: " + r.uri + "\n";

    s += "Headers:\n";
    for (h in r.headersIn) {
        s += "  header '" + h + "' is '" + r.headersIn[h] + "'\n";
    }

    s += "Args:\n";
    for (a in r.args) {
        s += "  arg '" + a + "' is '" + r.args[a] + "'\n";
    }

    return s;
}

function baz(r) {
    r.status = 200;
    r.headersOut.foo = 1234;
    r.headersOut['Content-Type'] = "text/plain; charset=utf-8";
    r.headersOut['Content-Length'] = 15;
    r.sendHeader();
    r.send("nginx");
    r.send("java");
    r.send("script");

    r.finish();
}

function hello(r) {
    r.return(200, "Hello world!");
}

// since 0.7.0
async function fetch(r) {
    let results = await Promise.all([ngx.fetch('https://nginx.org/'),
                                     ngx.fetch('https://nginx.org/en/')]);

    r.return(200, JSON.stringify(results, undefined, 4));
}

// since 0.7.0
async function hash(r) {
    let hash = await crypto.subtle.digest('SHA-512', r.headersIn.host);
    r.setReturnValue(Buffer.from(hash).toString('hex'));
}

export default {foo, summary, baz, hello, fetch, hash};

```

## Directives

### js_body_filter

{{< call-out >}}

**Syntax:** js_body_filter `function` | `module.function` [ `buffer_type` = `string` | `buffer` ]

**Default:** -

**Context:** location, if in location, limit_except

_This directive appeared in version 0.5.2._


{{</call-out>}}


Sets an njs function as a response body filter.
The filter function is called for each data chunk of a response body
with the following arguments:

`r`
the [HTTP request](/nginx/module-reference/../njs/reference#http) object
`data`
the incoming data chunk,
may be a string or Buffer
depending on the `buffer_type` value,
by default is a string.
Since [0.8.5](/nginx/module-reference/../njs/changes#njs0.8.5), the
`data` value is implicitly converted to a valid UTF-8 string
by default.
For binary data, the `buffer_type` value
should be set to `buffer`.
`flags`
an object with the following properties:
`last`
a boolean value, true if data is a last buffer.

The filter function can pass its own modified version
of the input data chunk to the next body filter by calling
[`r.sendBuffer()`](/nginx/module-reference/../njs/reference#r_sendbuffer).
For example, to transform all the lowercase letters in the response body:

```nginx
function filter(r, data, flags) {
    r.sendBuffer(data.toLowerCase(), flags);
}

```


If the filter function changes the length of the response body, the
`Content-Length` response header (if present) should be cleared
in [`js_header_filter`](#js_header_filter)
to enforce chunked transfer encoding:

```nginx
example.conf:
 location /foo {
     # proxy_pass http://localhost:8080;

    js_header_filter main.clear_content_length;
    js_body_filter   main.filter;
 }

example.js:
 function clear_content_length(r) {
     delete r.headersOut['Content-Length'];
 }

```


To stop filtering and pass the data chunks to the client
without calling `js_body_filter`,
[`r.done()`](/nginx/module-reference/../njs/reference#r_done)
can be used.
For example, to prepend some data to the response body:

```nginx
function prepend(r, data, flags) {
    r.sendBuffer("XXX");
    r.sendBuffer(data, flags);
    r.done();
}

```


As the `js_body_filter` handler
returns its result immediately, it supports
only synchronous operations.
Thus, asynchronous operations such as
[r.subrequest()](/nginx/module-reference/../njs/reference#r_subrequest)
or
[setTimeout()](/nginx/module-reference/../njs/reference#settimeout)
are not supported.

The directive can be specified inside the
[if](/nginx/module-reference/../http/ngx_http_rewrite_module#if) block
since [0.7.7](/nginx/module-reference/../njs/changes#njs0.7.7).
### js_content

{{< call-out >}}

**Syntax:** js_content `function` | `module.function`

**Default:** -

**Context:** location, if in location, limit_except


{{</call-out>}}


Sets an njs function as a location content handler.
Since [0.4.0](/nginx/module-reference/../njs/changes#njs0.4.0),
a module function can be referenced.

The directive can be specified inside the
[if](/nginx/module-reference/../http/ngx_http_rewrite_module#if) block
since [0.7.7](/nginx/module-reference/../njs/changes#njs0.7.7).
### js_context_reuse

{{< call-out >}}

**Syntax:** js_context_reuse `number`

**Default:** 128

**Context:** http, server, location

_This directive appeared in version 0.8.6._


{{</call-out>}}


Sets a maximum number of JS context to be reused for
[QuickJS engine](/nginx/module-reference/../njs/engine).
Each context is used for a single request.
The finished context is put into a pool of reusable contexts.
If the pool is full, the context is destroyed.
### js_engine

{{< call-out >}}

**Syntax:** js_engine `njs` | `qjs`

**Default:** njs

**Context:** http, server, location

_This directive appeared in version 0.8.6._


{{</call-out>}}


Sets a [JavaScript engine](/nginx/module-reference/../njs/engine)
to be used for njs scripts.
The `njs` parameter sets the njs engine, also used by default.
The `qjs` parameter sets the QuickJS engine.
### js_fetch_buffer_size

{{< call-out >}}

**Syntax:** js_fetch_buffer_size `size`

**Default:** 16k

**Context:** http, server, location

_This directive appeared in version 0.7.4._


{{</call-out>}}


Sets the `size` of the buffer used for reading and writing
with [Fetch API](/nginx/module-reference/../njs/reference#ngx_fetch).
### js_fetch_ciphers

{{< call-out >}}

**Syntax:** js_fetch_ciphers `ciphers`

**Default:** HIGH:!aNULL:!MD5

**Context:** http, server, location

_This directive appeared in version 0.7.0._


{{</call-out>}}


Specifies the enabled ciphers for HTTPS requests
with [Fetch API](/nginx/module-reference/../njs/reference#ngx_fetch).
The ciphers are specified in the format understood by the
OpenSSL library.

The full list can be viewed using the
‚Äúopenssl ciphers‚Äù command.
### js_fetch_max_response_buffer_size

{{< call-out >}}

**Syntax:** js_fetch_max_response_buffer_size `size`

**Default:** 1m

**Context:** http, server, location

_This directive appeared in version 0.7.4._


{{</call-out>}}


Sets the maximum `size` of the response received
with [Fetch API](/nginx/module-reference/../njs/reference#ngx_fetch).
### js_fetch_protocols

{{< call-out >}}

**Syntax:** js_fetch_protocols [ `TLSv1` ] [ `TLSv1.1` ] [ `TLSv1.2` ] [ `TLSv1.3` ]

**Default:** TLSv1 TLSv1.1 TLSv1.2

**Context:** http, server, location

_This directive appeared in version 0.7.0._


{{</call-out>}}


Enables the specified protocols for HTTPS requests
with [Fetch API](/nginx/module-reference/../njs/reference#ngx_fetch).
### js_fetch_timeout

{{< call-out >}}

**Syntax:** js_fetch_timeout `time`

**Default:** 60s

**Context:** http, server, location

_This directive appeared in version 0.7.4._


{{</call-out>}}


Defines a timeout for reading and writing
for [Fetch API](/nginx/module-reference/../njs/reference#ngx_fetch).
The timeout is set only between two successive read/write operations,
not for the whole response.
If no data is transmitted within this time, the connection is closed.
### js_fetch_trusted_certificate

{{< call-out >}}

**Syntax:** js_fetch_trusted_certificate `file`

**Default:** -

**Context:** http, server, location

_This directive appeared in version 0.7.0._


{{</call-out>}}


Specifies a `file` with trusted CA certificates in the PEM format
used to
[verify](/nginx/module-reference/../njs/reference#fetch_verify)
the HTTPS certificate
with [Fetch API](/nginx/module-reference/../njs/reference#ngx_fetch).
### js_fetch_verify

{{< call-out >}}

**Syntax:** js_fetch_verify `on` | `off`

**Default:** on

**Context:** http, server, location

_This directive appeared in version 0.7.4._


{{</call-out>}}


Enables or disables verification of the HTTPS server certificate
with [Fetch API](/nginx/module-reference/../njs/reference#ngx_fetch).
### js_fetch_verify_depth

{{< call-out >}}

**Syntax:** js_fetch_verify_depth `number`

**Default:** 100

**Context:** http, server, location

_This directive appeared in version 0.7.0._


{{</call-out>}}


Sets the verification depth in the HTTPS server certificates chain
with [Fetch API](/nginx/module-reference/../njs/reference#ngx_fetch).
### js_header_filter

{{< call-out >}}

**Syntax:** js_header_filter `function` | `module.function`

**Default:** -

**Context:** location, if in location, limit_except

_This directive appeared in version 0.5.1._


{{</call-out>}}


Sets an njs function as a response header filter.
The directive allows changing arbitrary header fields of a response header.

As the `js_header_filter` handler
returns its result immediately, it supports
only synchronous operations.
Thus, asynchronous operations such as
[r.subrequest()](/nginx/module-reference/../njs/reference#r_subrequest)
or
[setTimeout()](/nginx/module-reference/../njs/reference#settimeout)
are not supported.

The directive can be specified inside the
[if](/nginx/module-reference/../http/ngx_http_rewrite_module#if) block
since [0.7.7](/nginx/module-reference/../njs/changes#njs0.7.7).
### js_import

{{< call-out >}}

**Syntax:** js_import `module.js` | `export_name from module.js`

**Default:** -

**Context:** http, server, location

_This directive appeared in version 0.4.0._


{{</call-out>}}


Imports a module that implements location and variable handlers in njs.
The `export_name` is used as a namespace
to access module functions.
If the `export_name` is not specified,
the module name will be used as a namespace.

```nginx
js_import http.js;

```


Here, the module name `http` is used as a namespace
while accessing exports.
If the imported module exports `foo()`,
`http.foo` is used to refer to it.

Several `js_import` directives can be specified.

The directive can be specified on the
`server` and `location` level
since [0.7.7](/nginx/module-reference/../njs/changes#njs0.7.7).
### js_include

{{< call-out >}}

**Syntax:** js_include `file`

**Default:** -

**Context:** http


{{</call-out>}}


Specifies a file that implements location and variable handlers in njs:

```nginx
nginx.conf:
js_include http.js;
location   /version {
    js_content version;
}

http.js:
function version(r) {
    r.return(200, njs.version);
}

```


The directive was made obsolete in version
[0.4.0](/nginx/module-reference/../njs/changes#njs0.4.0)
and was removed in version
[0.7.1](/nginx/module-reference/../njs/changes#njs0.7.1).
The [](#js_import) directive should be used instead.
### js_path

{{< call-out >}}

**Syntax:** js_path `path`

**Default:** -

**Context:** http, server, location

_This directive appeared in version 0.3.0._


{{</call-out>}}


Sets an additional path for njs modules.

The directive can be specified on the
`server` and `location` level
since [0.7.7](/nginx/module-reference/../njs/changes#njs0.7.7).
### js_periodic

{{< call-out >}}

**Syntax:** js_periodic `function` | `module.function` [ `interval` = `time` ] [ `jitter` = `number` ] [ `worker_affinity` = `mask` ]

**Default:** -

**Context:** location

_This directive appeared in version 0.8.1._


{{</call-out>}}


Specifies a content handler to run at regular interval.
The handler receives a
[session object](/nginx/module-reference/../njs/reference#periodic_session)
as its first argument,
it also has access to global objects such as
[ngx](/nginx/module-reference/../njs/reference#ngx).

The optional `interval` parameter
sets the interval between two consecutive runs,
by default, 5 seconds.

The optional `jitter` parameter sets the time within which
the location content handler will be randomly delayed,
by default, there is no delay.

By default, the `js_handler` is executed on worker process 0.
The optional `worker_affinity` parameter
allows specifying particular worker processes
where the location content handler should be executed.
Each worker process set is represented by a bitmask of allowed worker processes.
The `all` mask allows the handler to be executed
in all worker processes.

Example:

```nginx
example.conf:

location @periodics {
    # to be run at 1 minute intervals in worker process 0
    js_periodic main.handler interval=60s;

    # to be run at 1 minute intervals in all worker processes
    js_periodic main.handler interval=60s worker_affinity=all;

    # to be run at 1 minute intervals in worker processes 1 and 3
    js_periodic main.handler interval=60s worker_affinity=0101;

    resolver 10.0.0.1;
    js_fetch_trusted_certificate /path/to/ISRG_Root_X1.pem;
}

example.js:

async function handler(s) {
    let reply = await ngx.fetch('https://nginx.org/en/docs/njs/');
    let body = await reply.text();

    ngx.log(ngx.INFO, body);
}

```

### js_preload_object

{{< call-out >}}

**Syntax:** js_preload_object `name.json` | `name` from `file.json`

**Default:** -

**Context:** http, server, location

_This directive appeared in version 0.7.8._


{{</call-out>}}


Preloads an
[immutable object](/nginx/module-reference/../njs/preload_objects)
at configure time.
The `name` is used as a name of the global variable
though which the object is available in njs code.
If the `name` is not specified,
the file name will be used instead.

```nginx
js_preload_object map.json;

```


Here, the `map` is used as a name
while accessing the preloaded object.

Several `js_preload_object` directives can be specified.
### js_set

{{< call-out >}}

**Syntax:** js_set `$variable` `function` | `module.function` [ `nocache` ]

**Default:** -

**Context:** http, server, location


{{</call-out>}}


Sets an njs `function`
for the specified `variable`.
Since [0.4.0](/nginx/module-reference/../njs/changes#njs0.4.0),
a module function can be referenced.

The function is called when
the variable is referenced for the first time for a given request.
The exact moment depends on a
[phase](/nginx/module-reference/../dev/development_guide#http_phases)
at which the variable is referenced.
This can be used to perform some logic
not related to variable evaluation.
For example, if the variable is referenced only in the
[log_format](/nginx/module-reference/http/ngx_http_log_module#log_format) directive,
its handler will not be executed until the log phase.
This handler can be used to do some cleanup
right before the request is freed.

Since [0.8.6](/nginx/module-reference/../njs/changes#njs0.8.6),
if an optional argument `nocache` is specified,
the handler is called every time it is referenced.
Due to current limitations
of the [rewrite](/nginx/module-reference/http/ngx_http_rewrite_module) module,
when a `nocache` variable is referenced by the
[set](/nginx/module-reference/http/ngx_http_rewrite_module#set) directive
its handler should always return a fixed-length value.

As the `js_set` handler
returns its result immediately, it supports
only synchronous operations.
Thus, asynchronous operations such as
[r.subrequest()](/nginx/module-reference/../njs/reference#r_subrequest)
or
[setTimeout()](/nginx/module-reference/../njs/reference#settimeout)
are not supported.

The directive can be specified on the
`server` and `location` level
since [0.7.7](/nginx/module-reference/../njs/changes#njs0.7.7).
### js_shared_dict_zone

{{< call-out >}}

**Syntax:** js_shared_dict_zone `zone` = `name` : `size` [ `timeout` = `time` ] [ `type` = `string` | `number` ] [ `evict` ] [ `state` = `file` ]

**Default:** -

**Context:** http

_This directive appeared in version 0.8.0._


{{</call-out>}}


Sets the `name` and `size` of the shared memory zone
that keeps the
key-value [dictionary](/nginx/module-reference/../njs/reference#dict)
shared between worker processes.

By default the shared dictionary uses a string as a key and a value.
The optional `type` parameter
allows redefining the value type to number.

The optional `timeout` parameter sets
the time in milliseconds
after which all shared dictionary entries are removed from the zone.
If some entries require a different removal time, it can be set
with the `timeout` argument of the
[add](/nginx/module-reference/../njs/reference#dict_add),
[incr](/nginx/module-reference/../njs/reference#dict_incr), and
[set](/nginx/module-reference/../njs/reference#dict_set)
methods
([0.8.5](/nginx/module-reference/../njs/changes#njs0.8.5)).

The optional `evict` parameter removes the oldest
key-value pair when the zone storage is exhausted.

The optional `state` parameter specifies a `file`
that keeps the shared dictionary state
in JSON format and makes it persistent across nginx restarts
([0.9.1](/nginx/module-reference/../njs/changes#njs0.9.1)).

Example:

```nginx
example.conf:
    # Creates a 1Mb dictionary with string values,
    # removes key-value pairs after 60 seconds of inactivity:
    js_shared_dict_zone zone=foo:1M timeout=60s;

    # Creates a 512Kb dictionary with string values,
    # forcibly removes oldest key-value pairs when the zone is exhausted:
    js_shared_dict_zone zone=bar:512K timeout=30s evict;

    # Creates a 32Kb permanent dictionary with number values:
    js_shared_dict_zone zone=num:32k type=number;

    # Creates a 1Mb dictionary with string values and persistent state:
    js_shared_dict_zone zone=persistent:1M state=/tmp/dict.json;

example.js:
    function get(r) {
        r.return(200, ngx.shared.foo.get(r.args.key));
    }

    function set(r) {
        r.return(200, ngx.shared.foo.set(r.args.key, r.args.value));
    }

    function del(r) {
        r.return(200, ngx.shared.bar.delete(r.args.key));
    }

    function increment(r) {
        r.return(200, ngx.shared.num.incr(r.args.key, 2));
    }

```

### js_var

{{< call-out >}}

**Syntax:** js_var `$variable` [ `value` ]

**Default:** -

**Context:** http, server, location

_This directive appeared in version 0.5.3._


{{</call-out>}}


Declares
a [writable](/nginx/module-reference/../njs/reference#r_variables)
variable.
The value can contain text, variables, and their combination.
The variable is not overwritten after a redirect
unlike variables created with the
[set](/nginx/module-reference/http/ngx_http_rewrite_module#set) directive.

The directive can be specified on the
`server` and `location` level
since [0.7.7](/nginx/module-reference/../njs/changes#njs0.7.7).
## Request Argument


Each HTTP njs handler receives one argument, a request
[object](/nginx/module-reference/../njs/reference#http).
