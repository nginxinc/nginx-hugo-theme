---
title: ngx_stream_js_module
description: ngx_stream_js_module
toc: true
nd-org-source: stream/ngx_stream_js_module.xml
nd-plus: false
nd-partial-plus: false
---


<!--
********************************************************************************
üõë WARNING: AUTOGENERATED FILE - DO NOT EDIT üõë
This Markdown file was automatically generated from the source XML documentation.
Any manual changes made directly to this file will be overwritten.
To request or suggest changes, please edit the source XML files instead.
https://github.com/nginx/nginx.org/tree/main/xml/en
********************************************************************************
-->


The `ngx_stream_js_module` module is used to implement
handlers in [njs](/nginx/module-reference/../njs/index)¬†‚Äî
a subset of the JavaScript language.

Download and install instructions are available
[here](/nginx/module-reference/../njs/install).
## Example Configuration


The example works since
[0.4.0](/nginx/module-reference/../njs/changes#njs0.4.0).

```nginx
stream {
    js_import stream.js;

    js_set $bar stream.bar;
    js_set $req_line stream.req_line;

    server {
        listen 12345;

        js_preread stream.preread;
        return     $req_line;
    }

    server {
        listen 12346;

        js_access  stream.access;
        proxy_pass 127.0.0.1:8000;
        js_filter  stream.header_inject;
    }
}

http {
    server {
        listen 8000;
        location / {
            return 200 $http_foo\n;
        }
    }
}

```


The stream.js file:

```nginx
var line = '';

function bar(s) {
    var v = s.variables;
    s.log("hello from bar() handler!");
    return "bar-var" + v.remote_port + "; pid=" + v.pid;
}

function preread(s) {
    s.on('upload', function (data, flags) {
        var n = data.indexOf('\n');
        if (n != -1) {
            line = data.substr(0, n);
            s.done();
        }
    });
}

function req_line(s) {
    return line;
}

// Read HTTP request line.
// Collect bytes in 'req' until
// request line is read.
// Injects HTTP header into a client's request

var my_header =  'Foo: foo';
function header_inject(s) {
    var req = '';
    s.on('upload', function(data, flags) {
        req += data;
        var n = req.search('\n');
        if (n != -1) {
            var rest = req.substr(n + 1);
            req = req.substr(0, n + 1);
            s.send(req + my_header + '\r\n' + rest, flags);
            s.off('upload');
        }
    });
}

function access(s) {
    if (s.remoteAddress.match('^192.*')) {
        s.deny();
        return;
    }

    s.allow();
}

export default {bar, preread, req_line, header_inject, access};

```

## Directives

### js_access

{{< call-out >}}

**Syntax:** js_access `function` | `module.function`

**Default:** -

**Context:** stream, server


{{</call-out>}}


Sets an njs function which will be called at the
[access](/nginx/module-reference/stream/stream_processing#access_phase) phase.
Since [0.4.0](/nginx/module-reference/../njs/changes#njs0.4.0),
a module function can be referenced.

The function is called once at the moment when the stream session reaches
the [access](/nginx/module-reference/stream/stream_processing#access_phase) phase
for the first time.
The function is called with the following arguments:

`s`
the [Stream Session](/nginx/module-reference/../njs/reference#stream) object

At this phase, it is possible to perform initialization
or register a callback with
the [`s.on()`](/nginx/module-reference/../njs/reference#s_on)
method
for each incoming data chunk until one of the following methods are called:
[`s.allow()`](/nginx/module-reference/../njs/reference#s_allow),
[`s.decline()`](/nginx/module-reference/../njs/reference#s_decline),
[`s.done()`](/nginx/module-reference/../njs/reference#s_done).
As soon as one of these methods is called, the stream session processing
switches to the [next phase](/nginx/module-reference/stream/stream_processing)
and all current
[`s.on()`](/nginx/module-reference/../njs/reference#s_on)
callbacks are dropped.
### js_context_reuse

{{< call-out >}}

**Syntax:** js_context_reuse `number`

**Default:** 128

**Context:** stream, server

_This directive appeared in version 0.8.6._


{{</call-out>}}


Sets a maximum number of JS context to be reused for
[QuickJS engine](/nginx/module-reference/../njs/engine).
Each context is used for a single stream session.
The finished context is put into a pool of reusable contexts.
If the pool is full, the context is destroyed.
### js_engine

{{< call-out >}}

**Syntax:** js_engine `njs` | `qjs`

**Default:** njs

**Context:** stream, server

_This directive appeared in version 0.8.6._


{{</call-out>}}


Sets a [JavaScript engine](/nginx/module-reference/../njs/engine)
to be used for njs scripts.
The `njs` parameter sets the njs engine, also used by default.
The `qjs` parameter sets the QuickJS engine.
### js_fetch_buffer_size

{{< call-out >}}

**Syntax:** js_fetch_buffer_size `size`

**Default:** 16k

**Context:** stream, server

_This directive appeared in version 0.7.4._


{{</call-out>}}


Sets the `size` of the buffer used for reading and writing
with [Fetch API](/nginx/module-reference/../njs/reference#ngx_fetch).
### js_fetch_ciphers

{{< call-out >}}

**Syntax:** js_fetch_ciphers `ciphers`

**Default:** HIGH:!aNULL:!MD5

**Context:** stream, server

_This directive appeared in version 0.7.0._


{{</call-out>}}


Specifies the enabled ciphers for HTTPS connections
with [Fetch API](/nginx/module-reference/../njs/reference#ngx_fetch).
The ciphers are specified in the format understood by the OpenSSL library.

The full list can be viewed using the
‚Äúopenssl ciphers‚Äù command.
### js_fetch_max_response_buffer_size

{{< call-out >}}

**Syntax:** js_fetch_max_response_buffer_size `size`

**Default:** 1m

**Context:** stream, server

_This directive appeared in version 0.7.4._


{{</call-out>}}


Sets the maximum `size` of the response received
with [Fetch API](/nginx/module-reference/../njs/reference#ngx_fetch).
### js_fetch_protocols

{{< call-out >}}

**Syntax:** js_fetch_protocols [ `TLSv1` ] [ `TLSv1.1` ] [ `TLSv1.2` ] [ `TLSv1.3` ]

**Default:** TLSv1 TLSv1.1 TLSv1.2

**Context:** stream, server

_This directive appeared in version 0.7.0._


{{</call-out>}}


Enables the specified protocols for HTTPS connections
with [Fetch API](/nginx/module-reference/../njs/reference#ngx_fetch).
### js_fetch_timeout

{{< call-out >}}

**Syntax:** js_fetch_timeout `time`

**Default:** 60s

**Context:** stream, server

_This directive appeared in version 0.7.4._


{{</call-out>}}


Defines a timeout for reading and writing
for [Fetch API](/nginx/module-reference/../njs/reference#ngx_fetch).
The timeout is set only between two successive read/write operations,
not for the whole response.
If no data is transmitted within this time, the connection is closed.
### js_fetch_trusted_certificate

{{< call-out >}}

**Syntax:** js_fetch_trusted_certificate `file`

**Default:** -

**Context:** stream, server

_This directive appeared in version 0.7.0._


{{</call-out>}}


Specifies a `file` with trusted CA certificates in the PEM format
used to
[verify](/nginx/module-reference/../njs/reference#fetch_verify)
the HTTPS certificate
with [Fetch API](/nginx/module-reference/../njs/reference#ngx_fetch).
### js_fetch_verify

{{< call-out >}}

**Syntax:** js_fetch_verify `on` | `off`

**Default:** on

**Context:** stream, server

_This directive appeared in version 0.7.4._


{{</call-out>}}


Enables or disables verification of the HTTPS server certificate
with [Fetch API](/nginx/module-reference/../njs/reference#ngx_fetch).
### js_fetch_verify_depth

{{< call-out >}}

**Syntax:** js_fetch_verify_depth `number`

**Default:** 100

**Context:** stream, server

_This directive appeared in version 0.7.0._


{{</call-out>}}


Sets the verification depth in the HTTPS server certificates chain
with [Fetch API](/nginx/module-reference/../njs/reference#ngx_fetch).
### js_filter

{{< call-out >}}

**Syntax:** js_filter `function` | `module.function`

**Default:** -

**Context:** stream, server


{{</call-out>}}


Sets a data filter.
Since [0.4.0](/nginx/module-reference/../njs/changes#njs0.4.0),
a module function can be referenced.
The filter function is called once at the moment when the stream session reaches
the [content](/nginx/module-reference/stream/stream_processing#content_phase) phase.

The filter function is called with the following arguments:
`s`
the [Stream Session](/nginx/module-reference/../njs/reference#stream) object

At this phase, it is possible to perform initialization
or register a callback with
the [`s.on()`](/nginx/module-reference/../njs/reference#s_on)
method for each incoming data chunk.
The
[`s.off()`](/nginx/module-reference/../njs/reference#s_off)
method may be used to unregister a callback and stop filtering.

As the `js_filter` handler
returns its result immediately, it supports
only synchronous operations.
Thus, asynchronous operations such as
[`ngx.fetch()`](/nginx/module-reference/../njs/reference#ngx_fetch)
or
[`setTimeout()`](/nginx/module-reference/../njs/reference#settimeout)
are not supported.
### js_import

{{< call-out >}}

**Syntax:** js_import `module.js` | `export_name from module.js`

**Default:** -

**Context:** stream, server

_This directive appeared in version 0.4.0._


{{</call-out>}}


Imports a module that implements location and variable handlers in njs.
The `export_name` is used as a namespace
to access module functions.
If the `export_name` is not specified,
the module name will be used as a namespace.

```nginx
js_import stream.js;

```


Here, the module name `stream` is used as a namespace
while accessing exports.
If the imported module exports `foo()`,
`stream.foo` is used to refer to it.

Several `js_import` directives can be specified.

The directive can be specified on the
`server` level
since [0.7.7](/nginx/module-reference/../njs/changes#njs0.7.7).
### js_include

{{< call-out >}}

**Syntax:** js_include `file`

**Default:** -

**Context:** stream


{{</call-out>}}


Specifies a file that implements server and variable handlers in njs:

```nginx
nginx.conf:
js_include stream.js;
js_set     $js_addr address;
server {
    listen 127.0.0.1:12345;
    return $js_addr;
}

stream.js:
function address(s) {
    return s.remoteAddress;
}

```


The directive was made obsolete in version
[0.4.0](/nginx/module-reference/../njs/changes#njs0.4.0)
and was removed in version
[0.7.1](/nginx/module-reference/../njs/changes#njs0.7.1).
The [](#js_import) directive should be used instead.
### js_path

{{< call-out >}}

**Syntax:** js_path `path`

**Default:** -

**Context:** stream, server

_This directive appeared in version 0.3.0._


{{</call-out>}}


Sets an additional path for njs modules.

The directive can be specified on the
`server` level
since [0.7.7](/nginx/module-reference/../njs/changes#njs0.7.7).
### js_periodic

{{< call-out >}}

**Syntax:** js_periodic `function` | `module.function` [ `interval` = `time` ] [ `jitter` = `number` ] [ `worker_affinity` = `mask` ]

**Default:** -

**Context:** server

_This directive appeared in version 0.8.1._


{{</call-out>}}


Specifies a content handler to run at regular interval.
The handler receives a
[session object](/nginx/module-reference/../njs/reference#periodic_session)
as its first argument,
it also has access to global objects such as
[ngx](/nginx/module-reference/../njs/reference#ngx).

The optional `interval` parameter
sets the interval between two consecutive runs,
by default, 5 seconds.

The optional `jitter` parameter sets the time within which
the location content handler will be randomly delayed,
by default, there is no delay.

By default, the `js_handler` is executed on worker process 0.
The optional `worker_affinity` parameter
allows specifying particular worker processes
where the location content handler should be executed.
Each worker process set is represented by a bitmask of allowed worker processes.
The `all` mask allows the handler to be executed
in all worker processes.

Example:

```nginx
example.conf:

location @periodics {
    # to be run at 1 minute intervals in worker process 0
    js_periodic main.handler interval=60s;

    # to be run at 1 minute intervals in all worker processes
    js_periodic main.handler interval=60s worker_affinity=all;

    # to be run at 1 minute intervals in worker processes 1 and 3
    js_periodic main.handler interval=60s worker_affinity=0101;

    resolver 10.0.0.1;
    js_fetch_trusted_certificate /path/to/ISRG_Root_X1.pem;
}

example.js:

async function handler(s) {
    let reply = await ngx.fetch('https://nginx.org/en/docs/njs/');
    let body = await reply.text();

    ngx.log(ngx.INFO, body);
}

```

### js_preload_object

{{< call-out >}}

**Syntax:** js_preload_object `name.json` | `name` from `file.json`

**Default:** -

**Context:** stream, server

_This directive appeared in version 0.7.8._


{{</call-out>}}


Preloads an
[immutable object](/nginx/module-reference/../njs/preload_objects)
at configure time.
The `name` is used as a name of the global variable
though which the object is available in njs code.
If the `name` is not specified,
the file name will be used instead.

```nginx
js_preload_object map.json;

```


Here, the `map` is used as a name
while accessing the preloaded object.

Several `js_preload_object` directives can be specified.
### js_preread

{{< call-out >}}

**Syntax:** js_preread `function` | `module.function`

**Default:** -

**Context:** stream, server


{{</call-out>}}


Sets an njs function which will be called at the
[preread](/nginx/module-reference/stream/stream_processing#preread_phase) phase.
Since [0.4.0](/nginx/module-reference/../njs/changes#njs0.4.0),
a module function can be referenced.

The function is called once
at the moment when the stream session reaches the
[preread](/nginx/module-reference/stream/stream_processing#preread_phase) phase
for the first time.
The function is called with the following arguments:

`s`
the [Stream Session](/nginx/module-reference/../njs/reference#stream) object

At this phase, it is possible to perform initialization
or register a callback with
the [`s.on()`](/nginx/module-reference/../njs/reference#s_on)
method
for each incoming data chunk until one of the following methods are called:
[`s.allow()`](/nginx/module-reference/../njs/reference#s_allow),
[`s.decline()`](/nginx/module-reference/../njs/reference#s_decline),
[`s.done()`](/nginx/module-reference/../njs/reference#s_done).
When one of these methods is called,
the stream session switches to the
[next phase](/nginx/module-reference/stream/stream_processing)
and all current
[`s.on()`](/nginx/module-reference/../njs/reference#s_on)
callbacks are dropped.

As the `js_preread` handler
returns its result immediately, it supports
only synchronous callbacks.
Thus, asynchronous callbacks such as
[`ngx.fetch()`](/nginx/module-reference/../njs/reference#ngx_fetch)
or
[`setTimeout()`](/nginx/module-reference/../njs/reference#settimeout)
are not supported.
Nevertheless, asynchronous operations are supported in
[`s.on()`](/nginx/module-reference/../njs/reference#s_on)
callbacks in the
[preread](/nginx/module-reference/stream/stream_processing#preread_phase) phase.
See
[this example](https://github.com/nginx/njs-examples#authorizing-connections-using-ngx-fetch-as-auth-request-stream-auth-request) for more information.
### js_set

{{< call-out >}}

**Syntax:** js_set `$variable` `function` | `module.function` [ `nocache` ]

**Default:** -

**Context:** stream, server


{{</call-out>}}


Sets an njs `function`
for the specified `variable`.
Since [0.4.0](/nginx/module-reference/../njs/changes#njs0.4.0),
a module function can be referenced.

The function is called when
the variable is referenced for the first time for a given request.
The exact moment depends on a
[phase](/nginx/module-reference/stream/stream_processing)
at which the variable is referenced.
This can be used to perform some logic
not related to variable evaluation.
For example, if the variable is referenced only in the
[log_format](/nginx/module-reference/stream/ngx_stream_log_module#log_format) directive,
its handler will not be executed until the log phase.
This handler can be used to do some cleanup
right before the request is freed.

Since [0.8.6](/nginx/module-reference/../njs/changes#njs0.8.6), when
optional argument `nocache` is provided the handler
is called every time it is referenced.
Due to current limitations
of the [rewrite](/nginx/module-reference/stream/ngx_stream_rewrite_module) module,
when a `nocache` variable is referenced by the
[set](/nginx/module-reference/stream/ngx_stream_set_module#set) directive
its handler should always return a fixed-length value.

As the `js_set` handler
returns its result immediately, it supports
only synchronous callbacks.
Thus, asynchronous callbacks such as
[ngx.fetch()](/nginx/module-reference/../njs/reference#ngx_fetch)
or
[setTimeout()](/nginx/module-reference/../njs/reference#settimeout)
are not supported.

The directive can be specified on the
`server` level
since [0.7.7](/nginx/module-reference/../njs/changes#njs0.7.7).
### js_shared_dict_zone

{{< call-out >}}

**Syntax:** js_shared_dict_zone `zone` = `name` : `size` [ `timeout` = `time` ] [ `type` = `string` | `number` ] [ `evict` ] [ `state` = `file` ]

**Default:** -

**Context:** stream

_This directive appeared in version 0.8.0._


{{</call-out>}}


Sets the `name` and `size` of the shared memory zone
that keeps the
key-value [dictionary](/nginx/module-reference/../njs/reference#dict)
shared between worker processes.

By default the shared dictionary uses a string as a key and a value.
The optional `type` parameter
allows redefining the value type to number.

The optional `timeout` parameter sets
the time in milliseconds
after which all shared dictionary entries are removed from the zone.
If some entries require a different removal time, it can be set
with the `timeout` argument of the
[add](/nginx/module-reference/../njs/reference#dict_add),
[incr](/nginx/module-reference/../njs/reference#dict_incr), and
[set](/nginx/module-reference/../njs/reference#dict_set)
methods
([0.8.5](/nginx/module-reference/../njs/changes#njs0.8.5)).

The optional `evict` parameter removes the oldest
key-value pair when the zone storage is exhausted.

The optional `state` parameter specifies a `file`
that keeps the shared dictionary state
in JSON format and makes it persistent across nginx restarts
([0.9.1](/nginx/module-reference/../njs/changes#njs0.9.1)).

Example:

```nginx
example.conf:
    # Creates a 1Mb dictionary with string values,
    # removes key-value pairs after 60 seconds of inactivity:
    js_shared_dict_zone zone=foo:1M timeout=60s;

    # Creates a 512Kb dictionary with string values,
    # forcibly removes oldest key-value pairs when the zone is exhausted:
    js_shared_dict_zone zone=bar:512K timeout=30s evict;

    # Creates a 32Kb permanent dictionary with number values:
    js_shared_dict_zone zone=num:32k type=number;

    # Creates a 1Mb dictionary with string values and persistent state:
    js_shared_dict_zone zone=persistent:1M state=/tmp/dict.json;

example.js:
    function get(r) {
        r.return(200, ngx.shared.foo.get(r.args.key));
    }

    function set(r) {
        r.return(200, ngx.shared.foo.set(r.args.key, r.args.value));
    }

    function del(r) {
        r.return(200, ngx.shared.bar.delete(r.args.key));
    }

    function increment(r) {
        r.return(200, ngx.shared.num.incr(r.args.key, 2));
    }

```

### js_var

{{< call-out >}}

**Syntax:** js_var `$variable` [ `value` ]

**Default:** -

**Context:** stream, server

_This directive appeared in version 0.5.3._


{{</call-out>}}


Declares
a [writable](/nginx/module-reference/../njs/reference#r_variables)
variable.
The value can contain text, variables, and their combination.

The directive can be specified on the
`server` level
since [0.7.7](/nginx/module-reference/../njs/changes#njs0.7.7).
## Session Object Properties


Each stream njs handler receives one argument, a stream session
[object](/nginx/module-reference/../njs/reference#stream).
